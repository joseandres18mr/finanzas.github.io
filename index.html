const ID_HOJA = "1Tyk_lDxTwMD9SIiy01nwoU7M6O8itdGni2kX8XF9paw"; // Tu ID
const NOMBRE_HOJA = "Transacciones";

function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    var ss = SpreadsheetApp.openById(ID_HOJA);
    var sheet = ss.getSheetByName(NOMBRE_HOJA);
    var data = null;

    // INTENTO 1: Leer como JSON (Lo ideal)
    try {
      if (e.postData && e.postData.contents) {
        data = JSON.parse(e.postData.contents);
      }
    } catch (err) {}

    // INTENTO 2: Leer como Formulario (Respaldo)
    if (!data) {
      data = e.parameter;
    }

    // --- ACCIÓN: PAGAR DEUDA ---
    if (data && data.accion === "actualizar_estado") {
      var idBuscado = String(data.id).trim(); // Limpiar ID
      var dataRange = sheet.getDataRange();
      var values = dataRange.getValues();
      var filaEncontrada = -1;

      // Buscar ID ignorando formatos
      for (var i = 1; i < values.length; i++) {
        var idEnFila = String(values[i][0]).trim();
        if (idEnFila === idBuscado) {
          filaEncontrada = i + 1;
          break;
        }
      }

      if (filaEncontrada > 0) {
        sheet.getRange(filaEncontrada, 9).setValue("PAGADO"); // Columna I
        SpreadsheetApp.flush(); // FORZAR GUARDADO INMEDIATO
        return ContentService.createTextOutput("PAGADO_OK");
      }
      return ContentService.createTextOutput("ERROR_ID_NO_ENCONTRADO");
    }

    // --- ACCIÓN: REGISTRAR ---
    // Mapeo de nombres cariñosos a nombres reales para la base de datos
    var usuarioReal = data.usuario;
    if (usuarioReal === "Mi papi") usuarioReal = "Jose";
    if (usuarioReal === "Mi mami") usuarioReal = "Gabriela";

    var esCompartido = (data.es_compartido === 'on' || data.es_compartido === true);
    var estado = "";
    
    if (data.tipo === 'Ingreso') estado = "-";
    else if (esCompartido) estado = "IMPAGO";
    else estado = "PERSONAL";

    sheet.appendRow([
      Utilities.getUuid(),
      new Date(),
      usuarioReal, // Guardamos "Jose" o "Gabriela" en el Excel, no "Papi/Mami"
      data.tipo,
      data.categoria,
      data.monto,
      data.descripcion,
      esCompartido ? "TRUE" : "FALSE",
      estado
    ]);

    return ContentService.createTextOutput("REGISTRO_OK");

  } catch (error) {
    return ContentService.createTextOutput("ERROR: " + error.toString());
  } finally {
    lock.releaseLock();
  }
}

function doGet(e) {
  var ss = SpreadsheetApp.openById(ID_HOJA);
  var sheet = ss.getSheetByName(NOMBRE_HOJA);
  var rows = sheet.getDataRange().getValues();
  
  var stats = {
    "Jose": { ingresos: 0, gastos: 0, saldo: 0, desglose: {}, compartidos: [] },
    "Gabriela": { ingresos: 0, gastos: 0, saldo: 0, desglose: {}, compartidos: [] }
  };

  var mesActual = new Date().getMonth();
  var anioActual = new Date().getFullYear();

  for (var i = 1; i < rows.length; i++) {
    var fila = rows[i];
    var id = String(fila[0]).trim();
    var fecha = new Date(fila[1]);
    var usuario = fila[2]; // En el Excel dice Jose/Gabriela
    var tipo = fila[3];
    var categoria = fila[4];
    var monto = parseFloat(fila[5]);
    var desc = fila[6] || "Sin descripción";
    var esCompartido = (fila[7] === "TRUE" || fila[7] === true);
    var estado = String(fila[8]).trim();

    if (fecha.getMonth() === mesActual && fecha.getFullYear() === anioActual) {
      var fechaFmt = Utilities.formatDate(fecha, Session.getScriptTimeZone(), "dd/MM");

      if (tipo === 'Ingreso') {
        if (stats[usuario]) stats[usuario].ingresos += monto;
      } else {
        if (esCompartido) {
          var mitad = monto / 2;
          var item = { id: id, desc: desc, montoTotal: monto, miParte: mitad, fecha: fechaFmt, estado: estado, acreedor: usuario };
          
          // Cruzar deudas
          if (usuario === "Jose") {
            stats["Gabriela"].compartidos.push(item);
            sumarGasto(stats, "Jose", categoria, mitad, desc, fechaFmt);
            sumarGasto(stats, "Gabriela", categoria, mitad, desc, fechaFmt);
          } else if (usuario === "Gabriela") {
            stats["Jose"].compartidos.push(item);
            sumarGasto(stats, "Gabriela", categoria, mitad, desc, fechaFmt);
            sumarGasto(stats, "Jose", categoria, mitad, desc, fechaFmt);
          }
        } else {
          if (stats[usuario]) sumarGasto(stats, usuario, categoria, monto, desc, fechaFmt);
        }
      }
    }
  }
  stats["Jose"].saldo = stats["Jose"].ingresos - stats["Jose"].gastos;
  stats["Gabriela"].saldo = stats["Gabriela"].ingresos - stats["Gabriela"].gastos;

  return ContentService.createTextOutput(JSON.stringify(stats)).setMimeType(ContentService.MimeType.JSON);
}

function sumarGasto(obj, user, cat, monto, desc, fecha) {
  obj[user].gastos += monto;
  if (!obj[user].desglose[cat]) obj[user].desglose[cat] = { valor: 0, items: [] };
  obj[user].desglose[cat].valor += monto;
  obj[user].desglose[cat].items.push({ monto: monto, desc: desc, fecha: fecha });
}
