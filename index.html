<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas J&G</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: system-ui, -apple-system, sans-serif; }
        .card { border-radius: 16px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .form-control, .form-select { border-radius: 12px; padding: 12px; font-size: 1rem; }
        .btn-lg { border-radius: 12px; font-weight: 600; padding: 14px; }
        
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .avatar-btn {
            width: 120px; height: 120px; border-radius: 50%; border: 4px solid white;
            background-color: white; font-size: 3rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .avatar-btn:active { transform: scale(0.95); }

        /* Estilos Compartidos */
        .shared-item { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.3s; }
        .shared-item.pagado { border-left-color: #2ed573; opacity: 0.7; }
        .shared-item.impago { border-left-color: #ff4757; }
        .badge-status { font-size: 0.7rem; padding: 4px 8px; border-radius: 6px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="text-center text-white">
        <h1 class="fw-bold mb-4">ğŸ’° Finanzas J&G</h1>
        <p class="mb-5 opacity-75">Â¿QuiÃ©n eres?</p>
        <div class="d-flex gap-4 justify-content-center">
            <div class="text-center"><div class="avatar-btn text-primary mb-2" onclick="iniciarSesion('Jose')">ğŸ‘¨ğŸ»â€ğŸ’»</div><div class="fw-bold">Jose</div></div>
            <div class="text-center"><div class="avatar-btn text-danger mb-2" onclick="iniciarSesion('Gabriela')">ğŸ‘©ğŸ»â€ğŸ¨</div><div class="fw-bold">Gabriela</div></div>
        </div>
    </div>
</div>

<div id="app-screen" class="container py-3" style="max-width: 600px; display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3 px-2">
        <div><h3 class="fw-bold m-0" id="saludo-usuario">Hola!</h3><small class="text-muted">Control Mensual</small></div>
        <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="cerrarSesion()">Salir</button>
    </div>

    <ul class="nav nav-pills nav-fill mb-3 bg-white p-1 rounded-3 shadow-sm">
        <li class="nav-item"><button class="nav-link active fw-bold" id="registro-tab" data-bs-toggle="tab" data-bs-target="#registro-pane">ğŸ“ Registrar</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" id="graficos-tab" data-bs-toggle="tab" data-bs-target="#graficos-pane" onclick="cargarDatos()">ğŸ“Š Mis Gastos</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="registro-pane">
            <div class="card">
                <div class="card-body p-4">
                    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
                    <form id="financeForm" 
                          action="https://script.google.com/macros/s/AKfycbz2hTiT_DCceJkzh0_rMjy0EJkbDAgXEyztYAVNNMIAkb4CwQC1ySajrmmB8U7KO8ubuQ/exec" 
                          method="POST" target="hidden_iframe">
                        <input type="hidden" name="usuario" id="usuario-input">
                        <div class="row g-2 mb-3">
                            <div class="col-5">
                                <label class="fw-bold small text-muted">TIPO</label>
                                <select class="form-select" name="tipo" id="tipoSelector" onchange="cambiarColor()">
                                    <option value="Gasto">Gasto ğŸ“‰</option><option value="Ingreso">Ingreso ğŸ“ˆ</option>
                                </select>
                            </div>
                            <div class="col-7">
                                <label class="fw-bold small text-muted">MONTO</label>
                                <div class="input-group"><span class="input-group-text border-0 bg-light">$</span><input type="text" class="form-control" name="monto" id="monto" placeholder="0" required inputmode="numeric"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold small text-muted">CATEGORÃA</label>
                            <select class="form-select" name="categoria">
                                <option value="Supermercado">ğŸ›’ Supermercado</option>
                                <option value="Comida Fuera">ğŸ” Comida / Delivery</option>
                                <option value="Transporte">ğŸšŒ Transporte / Bencina</option>
                                <option value="Cuentas">ğŸ’¡ Cuentas / Servicios</option>
                                <option value="Arriendo">ğŸ  Arriendo / GC</option>
                                <option value="Mascotas">ğŸ¶ Mascotas</option>
                                <option value="Salud">ğŸ’Š Salud / Farmacia</option>
                                <option value="Ocio">ğŸ® Ocio / Streaming</option>
                                <option value="Otros">ğŸ“¦ Otros</option>
                            </select>
                        </div>
                        <div class="mb-3"><input type="text" class="form-control" name="descripcion" placeholder="DescripciÃ³n (Opcional)"></div>
                        <div class="alert alert-light border d-flex justify-content-between align-items-center">
                            <div><strong class="d-block small">Â¿Compartido? (50/50)</strong></div>
                            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="es_compartido"></div>
                        </div>
                        <button type="submit" class="btn btn-danger w-100 btn-lg shadow-sm" id="btnSubmit">Registrar</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="graficos-pane">
            <div id="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Analizando finanzas...</p>
            </div>

            <div id="stats-content" style="display:none;">
                <div class="card mb-3 bg-white border border-primary border-opacity-25">
                    <div class="card-body text-center pt-4">
                        <small class="text-uppercase text-muted fw-bold">Tu Gasto Total (Mes)</small>
                        <h1 class="display-4 fw-bold text-primary my-2" id="mi-total">$0</h1>
                        <p class="small text-muted mb-0">(Tus gastos + tu parte compartida)</p>
                    </div>
                </div>

                <div class="d-grid gap-2 mb-4">
                    <button class="btn btn-warning shadow-sm py-3 fw-bold text-dark" onclick="verCompartidos()">
                        ğŸ¤ Ver Gastos Compartidos / Pagar
                    </button>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">Tu DistribuciÃ³n (Click para detalle)</h6>
                        <div style="height:250px; position:relative;"><canvas id="miChart"></canvas></div>
                    </div>
                </div>
                
                <button class="btn btn-light border w-100" onclick="cargarDatos()">ğŸ”„ Actualizar datos</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detalleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header border-0"><h5 class="modal-title fw-bold" id="modalTitulo">Detalle</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body pt-0"><div id="lista-detalle"></div></div>
        </div>
    </div>
</div>

<div class="modal fade" id="compartidosModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" style="background-color: #f8f9fa;">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">ğŸ¤ Gastos Compartidos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0">
                <div class="alert alert-info small mb-3">
                    AquÃ­ ves todos los gastos compartidos. Marca los que ya se pagaron.
                </div>
                <div id="lista-compartidos">
                    </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // !!! PEGA TU URL AQUI !!!
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2hTiT_DCceJkzh0_rMjy0EJkbDAgXEyztYAVNNMIAkb4CwQC1ySajrmmB8U7KO8ubuQ/exec";
    
    let usuarioActual = "";
    let myChart = null;
    let datosCompletos = null;

    // --- LOGIN ---
    function iniciarSesion(nombre) {
        usuarioActual = nombre;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'block';
        document.getElementById('saludo-usuario').innerText = "Hola, " + nombre + "!";
        document.getElementById('usuario-input').value = nombre;
    }
    function cerrarSesion() { location.reload(); }

    // --- REGISTRO ---
    const montoInput = document.getElementById('monto');
    const form = document.getElementById('financeForm');
    const btnSubmit = document.getElementById('btnSubmit');
    var submitted = false;

    montoInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, "");
        e.target.value = value ? new Intl.NumberFormat('es-CL').format(value) : "";
    });

    function cambiarColor() {
        const tipo = document.getElementById('tipoSelector').value;
        if(tipo === 'Gasto') {
            btnSubmit.className = 'btn btn-danger w-100 btn-lg shadow-sm';
            btnSubmit.innerText = 'Registrar Gasto';
        } else {
            btnSubmit.className = 'btn btn-success w-100 btn-lg shadow-sm';
            btnSubmit.innerText = 'Registrar Ingreso';
        }
    }
    form.onsubmit = function() {
        submitted = true;
        btnSubmit.innerText = "Guardando...";
        btnSubmit.disabled = true;
    };
    document.getElementById('hidden_iframe').onload = function() {
        if (submitted) {
            alert("âœ… Â¡Registrado (Estado: IMPAGO)!");
            form.reset();
            document.getElementById('usuario-input').value = usuarioActual;
            btnSubmit.innerText = "Registrar Gasto";
            btnSubmit.disabled = false;
            submitted = false;
            cambiarColor();
        }
    };

    // --- DATOS Y GRÃFICOS ---
    function cargarDatos() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('stats-content').style.display = 'none';
        fetch(APPS_SCRIPT_URL)
            .then(response => response.json())
            .then(data => {
                datosCompletos = data;
                const datosUsuario = data[usuarioActual];
                document.getElementById('mi-total').innerText = "$ " + new Intl.NumberFormat('es-CL').format(datosUsuario.total);
                mostrarGrafico(datosUsuario.desglose);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('stats-content').style.display = 'block';
            })
            .catch(error => { console.error(error); document.getElementById('loading').innerHTML = "Error conexiÃ³n"; });
    }

    function mostrarGrafico(desglose) {
        const ctx = document.getElementById('miChart').getContext('2d');
        if (myChart) myChart.destroy();
        const labels = Object.keys(desglose);
        const dataValues = labels.map(key => desglose[key].valor);
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: dataValues,
                    backgroundColor: ['#ff7675', '#74b9ff', '#ffeaa7', '#55efc4', '#a29bfe', '#fab1a0', '#00b894'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                onClick: (evt, elements) => {
                    if(elements.length > 0) {
                        const index = elements[0].index;
                        abrirModalDetalle(labels[index]);
                    }
                },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    // --- MODAL DETALLE (Fecha + Desc) ---
    function abrirModalDetalle(categoria) {
        const items = datosCompletos[usuarioActual].desglose[categoria].items;
        const lista = document.getElementById('lista-detalle');
        document.getElementById('modalTitulo').innerText = "Detalle: " + categoria;
        lista.innerHTML = ""; 

        items.forEach(item => {
            const montoFmt = new Intl.NumberFormat('es-CL').format(item.monto);
            const fecha = item.fecha || "";
            const fila = `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <div>
                        <div class="fw-bold">${item.desc}</div>
                        <div class="small text-muted">ğŸ“… ${fecha}</div>
                    </div>
                    <div class="text-danger fw-bold">$ ${montoFmt}</div>
                </div>`;
            lista.insertAdjacentHTML('beforeend', fila);
        });
        new bootstrap.Modal(document.getElementById('detalleModal')).show();
    }

    // --- GESTIÃ“N DE COMPARTIDOS (PAGAR/IMPAGO) ---
    function verCompartidos() {
        const items = datosCompletos[usuarioActual].compartidos;
        const lista = document.getElementById('lista-compartidos');
        lista.innerHTML = "";

        if (items.length === 0) {
            lista.innerHTML = "<p class='text-center text-muted'>No hay gastos compartidos este mes.</p>";
        } else {
            items.forEach(item => {
                const totalFmt = new Intl.NumberFormat('es-CL').format(item.montoTotal);
                const parteFmt = new Intl.NumberFormat('es-CL').format(item.miParte);
                const esPagado = item.estado === "PAGADO";
                const claseEstado = esPagado ? "pagado" : "impago";
                const textoEstado = esPagado ? "PAGADO âœ…" : "IMPAGO âŒ";
                const badgeClass = esPagado ? "bg-success" : "bg-danger";
                const checkAttr = esPagado ? "checked disabled" : ""; // Disabled para que no lo des-paguen por error

                const html = `
                    <div class="shared-item ${claseEstado}" id="card-${item.id}">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge bg-light text-dark border">ğŸ“… ${item.fecha}</span>
                            <span class="badge ${badgeClass} badge-status">${textoEstado}</span>
                        </div>
                        <h6 class="fw-bold mb-1">${item.desc}</h6>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="small">
                                <div>Total: $${totalFmt}</div>
                                <div class="fw-bold text-primary">Tu parte: $${parteFmt}</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" style="width:3em; height:1.5em;" 
                                       onchange="marcarPagado('${item.id}', this)" ${checkAttr}>
                            </div>
                        </div>
                    </div>
                `;
                lista.insertAdjacentHTML('beforeend', html);
            });
        }
        new bootstrap.Modal(document.getElementById('compartidosModal')).show();
    }

    function marcarPagado(id, checkbox) {
        if (!confirm("Â¿Marcar este gasto como PAGADO?")) {
            checkbox.checked = false;
            return;
        }

        // Bloquear visualmente
        checkbox.disabled = true;
        document.getElementById(`card-${id}`).style.opacity = "0.5";

        // Enviar a Apps Script
        const payload = { accion: "actualizar_estado", id: id, estado: "PAGADO" };

        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            // Actualizar visualmente al Ã©xito (simulado por no-cors)
            const card = document.getElementById(`card-${id}`);
            card.classList.remove('impago');
            card.classList.add('pagado');
            card.querySelector('.badge-status').className = "badge bg-success badge-status";
            card.querySelector('.badge-status').innerText = "PAGADO âœ…";
            card.style.opacity = "0.7";
            alert("âœ… Gasto actualizado a PAGADO");
        }).catch(e => {
            alert("Error al conectar");
            checkbox.disabled = false;
            checkbox.checked = false;
        });
    }
</script>

</body>
</html>
