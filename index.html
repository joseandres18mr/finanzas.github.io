function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Transacciones");
    
    // LOGICA INTELIGENTE: Detecta si viene del formulario HTML o de JSON
    var data;
    if (e.postData && e.postData.type == "application/json") {
      data = JSON.parse(e.postData.contents); // Caso Fetch JSON
    } else {
      data = e.parameter; // Caso Formulario HTML Standard
    }

    // Convertir checkbox "on" a TRUE/FALSE real
    var compartido = false;
    if (data.es_compartido === 'on' || data.es_compartido === true || data.es_compartido === 'true') {
      compartido = true;
    }

    // Guardar
    sheet.appendRow([
      Utilities.getUuid(),
      new Date(),
      data.usuario,
      data.tipo,
      data.categoria,
      data.monto,
      data.descripcion,
      compartido
    ]);

    return ContentService.createTextOutput("Guardado");
  } catch (e) {
    return ContentService.createTextOutput("Error: " + e.toString());
  } finally {
    lock.releaseLock();
  }
}
