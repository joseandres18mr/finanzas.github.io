<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas J&G</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: system-ui, -apple-system, sans-serif; }
        .card { border-radius: 16px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .form-control, .form-select { border-radius: 12px; padding: 12px; font-size: 1rem; }
        .btn-lg { border-radius: 12px; font-weight: 600; padding: 14px; }
        
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .avatar-btn {
            width: 120px; height: 120px; border-radius: 50%; border: 4px solid white;
            background-color: white; font-size: 3rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .avatar-btn:active { transform: scale(0.95); }

        .resumen-card { text-align: center; padding: 15px; border-radius: 12px; color: white; margin-bottom: 10px; }
        .bg-ingreso { background: linear-gradient(45deg, #2ed573, #7bed9f); }
        .bg-gasto { background: linear-gradient(45deg, #ff4757, #ff6b81); }
        .bg-saldo { background: linear-gradient(45deg, #1e90ff, #70a1ff); }

        .shared-item { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .shared-item.pagado { border-left-color: #2ed573; opacity: 0.6; }
        .shared-item.impago { border-left-color: #ff4757; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="text-center text-white">
        <h1 class="fw-bold mb-4">ğŸ’° Finanzas J&G</h1>
        <p class="mb-5 opacity-75">Â¿QuiÃ©n eres?</p>
        <div class="d-flex gap-4 justify-content-center">
            <div class="text-center"><div class="avatar-btn text-primary mb-2" onclick="iniciarSesion('Jose')">ğŸ‘¨ğŸ»â€ğŸ’»</div><div class="fw-bold">Jose</div></div>
            <div class="text-center"><div class="avatar-btn text-danger mb-2" onclick="iniciarSesion('Gabriela')">ğŸ‘©ğŸ»â€ğŸ¨</div><div class="fw-bold">Gabriela</div></div>
        </div>
    </div>
</div>

<div id="app-screen" class="container py-3" style="max-width: 600px; display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3 px-2">
        <div><h3 class="fw-bold m-0" id="saludo-usuario">Hola!</h3><small class="text-muted">Control Mensual</small></div>
        <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="cerrarSesion()">Salir</button>
    </div>

    <ul class="nav nav-pills nav-fill mb-3 bg-white p-1 rounded-3 shadow-sm">
        <li class="nav-item"><button class="nav-link active fw-bold" id="registro-tab" data-bs-toggle="tab" data-bs-target="#registro-pane">ğŸ“ Registrar</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" id="graficos-tab" data-bs-toggle="tab" data-bs-target="#graficos-pane" onclick="cargarDatos()">ğŸ“Š Mi Billetera</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="registro-pane">
            <div class="card">
                <div class="card-body p-4">
                    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
                    <form id="financeForm" 
                          action="https://script.google.com/macros/s/AKfycbz2hTiT_DCceJkzh0_rMjy0EJkbDAgXEyztYAVNNMIAkb4CwQC1ySajrmmB8U7KO8ubuQ/exec" 
                          method="POST" target="hidden_iframe">
                        <input type="hidden" name="usuario" id="usuario-input">
                        <div class="row g-2 mb-3">
                            <div class="col-5">
                                <label class="fw-bold small text-muted">TIPO</label>
                                <select class="form-select" name="tipo" id="tipoSelector" onchange="cambiarColor()">
                                    <option value="Gasto">Gasto ğŸ“‰</option><option value="Ingreso">Ingreso ğŸ“ˆ</option>
                                </select>
                            </div>
                            <div class="col-7">
                                <div class="input-group"><span class="input-group-text border-0 bg-light">$</span><input type="text" class="form-control" name="monto" id="monto" placeholder="0" required inputmode="numeric"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <select class="form-select" name="categoria">
                                <option value="Supermercado">ğŸ›’ Supermercado</option>
                                <option value="Comida Fuera">ğŸ” Comida / Delivery</option>
                                <option value="Transporte">ğŸšŒ Transporte / Bencina</option>
                                <option value="Cuentas">ğŸ’¡ Cuentas / Servicios</option>
                                <option value="Arriendo">ğŸ  Arriendo / GC</option>
                                <option value="Mascotas">ğŸ¶ Mascotas</option>
                                <option value="Salud">ğŸ’Š Salud / Farmacia</option>
                                <option value="Ocio">ğŸ® Ocio / Streaming</option>
                                <option value="Sueldo">ğŸ’° Sueldo / Ingreso</option>
                                <option value="Otros">ğŸ“¦ Otros</option>
                            </select>
                        </div>
                        <div class="mb-3"><input type="text" class="form-control" name="descripcion" placeholder="DescripciÃ³n (Opcional)"></div>
                        <div class="alert alert-light border d-flex justify-content-between align-items-center" id="div-compartido">
                            <div><strong class="d-block small">Â¿Compartido? (50/50)</strong></div>
                            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="es_compartido"></div>
                        </div>
                        <button type="submit" class="btn btn-danger w-100 btn-lg shadow-sm" id="btnSubmit">Registrar</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="graficos-pane">
            <div id="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Cargando...</p>
            </div>

            <div id="stats-content" style="display:none;">
                <div class="row g-2 mb-3">
                    <div class="col-4"><div class="resumen-card bg-ingreso"><small>Ingresos</small><div class="fw-bold" id="mi-ingreso">$0</div></div></div>
                    <div class="col-4"><div class="resumen-card bg-gasto"><small>Gastos</small><div class="fw-bold" id="mi-gasto">$0</div></div></div>
                    <div class="col-4"><div class="resumen-card bg-saldo"><small>Saldo</small><div class="fw-bold" id="mi-saldo">$0</div></div></div>
                </div>

                <div class="d-grid gap-2 mb-4">
                    <button class="btn btn-warning shadow-sm py-3 fw-bold text-dark position-relative" onclick="verCompartidos()">
                        ğŸ’¸ Pagar Deudas
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="badge-deudas" style="display:none">0</span>
                    </button>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">Tus Gastos</h6>
                        <div style="height:250px; position:relative;"><canvas id="miChart"></canvas></div>
                    </div>
                </div>
                <button class="btn btn-light border w-100" onclick="cargarDatos()">ğŸ”„ Actualizar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detalleModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header border-0"><h5 class="modal-title fw-bold" id="modalTitulo">Detalle</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body pt-0"><div id="lista-detalle"></div></div></div></div></div>

<div class="modal fade" id="compartidosModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" style="background-color: #f8f9fa;">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">ğŸ’¸ Tus Deudas por Pagar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0">
                <div id="lista-compartidos"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // !!! PEGA TU URL AQUI !!!
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2hTiT_DCceJkzh0_rMjy0EJkbDAgXEyztYAVNNMIAkb4CwQC1ySajrmmB8U7KO8ubuQ/exec";
    
    let usuarioActual = "";
    let myChart = null;
    let datosCompletos = null;

    function iniciarSesion(nombre) {
        usuarioActual = nombre;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'block';
        document.getElementById('saludo-usuario').innerText = "Hola, " + nombre + "!";
        document.getElementById('usuario-input').value = nombre;
    }
    function cerrarSesion() { location.reload(); }

    const montoInput = document.getElementById('monto');
    const form = document.getElementById('financeForm');
    const btnSubmit = document.getElementById('btnSubmit');
    var submitted = false;

    montoInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, "");
        e.target.value = value ? new Intl.NumberFormat('es-CL').format(value) : "";
    });

    function cambiarColor() {
        const tipo = document.getElementById('tipoSelector').value;
        const divCompartido = document.getElementById('div-compartido');
        if(tipo === 'Gasto') {
            btnSubmit.className = 'btn btn-danger w-100 btn-lg shadow-sm';
            btnSubmit.innerText = 'Registrar Gasto';
            divCompartido.style.display = 'flex';
        } else {
            btnSubmit.className = 'btn btn-success w-100 btn-lg shadow-sm';
            btnSubmit.innerText = 'Registrar Ingreso';
            divCompartido.style.display = 'none';
            form.es_compartido.checked = false;
        }
    }
    form.onsubmit = function() {
        submitted = true;
        btnSubmit.innerText = "Guardando...";
        btnSubmit.disabled = true;
    };
    document.getElementById('hidden_iframe').onload = function() {
        if (submitted) {
            alert("âœ… Â¡Registrado!");
            form.reset();
            document.getElementById('usuario-input').value = usuarioActual;
            btnSubmit.innerText = "Registrar Gasto";
            btnSubmit.disabled = false;
            submitted = false;
            cambiarColor();
        }
    };

    function cargarDatos() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('stats-content').style.display = 'none';
        fetch(APPS_SCRIPT_URL)
            .then(response => response.json())
            .then(data => {
                datosCompletos = data;
                const datosUsuario = data[usuarioActual];
                const fmt = (n) => "$ " + new Intl.NumberFormat('es-CL').format(n);
                document.getElementById('mi-ingreso').innerText = fmt(datosUsuario.ingresos);
                document.getElementById('mi-gasto').innerText = fmt(datosUsuario.gastos);
                document.getElementById('mi-saldo').innerText = fmt(datosUsuario.saldo);

                // Actualizar contador de deudas pendientes
                const pendientes = datosUsuario.compartidos.filter(i => i.estado === "IMPAGO").length;
                const badge = document.getElementById('badge-deudas');
                if (pendientes > 0) {
                    badge.innerText = pendientes;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }

                mostrarGrafico(datosUsuario.desglose);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('stats-content').style.display = 'block';
            })
            .catch(error => { console.error(error); });
    }

    function mostrarGrafico(desglose) {
        const ctx = document.getElementById('miChart').getContext('2d');
        if (myChart) myChart.destroy();
        const labels = Object.keys(desglose);
        const dataValues = labels.map(key => desglose[key].valor);
        if(dataValues.length === 0) return;

        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: dataValues,
                    backgroundColor: ['#ff7675', '#74b9ff', '#ffeaa7', '#55efc4', '#a29bfe', '#fab1a0', '#00b894'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                onClick: (evt, elements) => {
                    if(elements.length > 0) {
                        const index = elements[0].index;
                        abrirModalDetalle(labels[index]);
                    }
                },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function abrirModalDetalle(categoria) {
        const items = datosCompletos[usuarioActual].desglose[categoria].items;
        const lista = document.getElementById('lista-detalle');
        document.getElementById('modalTitulo').innerText = "Detalle: " + categoria;
        lista.innerHTML = ""; 
        items.forEach(item => {
            const montoFmt = new Intl.NumberFormat('es-CL').format(item.monto);
            lista.insertAdjacentHTML('beforeend', `<div class="d-flex justify-content-between py-2 border-bottom"><div><div class="fw-bold">${item.desc}</div><div class="small text-muted">ğŸ“… ${item.fecha}</div></div><div class="text-danger fw-bold">$ ${montoFmt}</div></div>`);
        });
        new bootstrap.Modal(document.getElementById('detalleModal')).show();
    }

    function verCompartidos() {
        const items = datosCompletos[usuarioActual].compartidos;
        const lista = document.getElementById('lista-compartidos');
        lista.innerHTML = "";

        if (items.length === 0) {
            lista.innerHTML = "<p class='text-center text-muted py-3'>ğŸ‰ Â¡EstÃ¡s al dÃ­a! No le debes nada a nadie.</p>";
        } else {
            items.forEach(item => {
                const parteFmt = new Intl.NumberFormat('es-CL').format(item.miParte);
                const esPagado = item.estado === "PAGADO";
                const claseEstado = esPagado ? "pagado" : "impago";
                const textoEstado = esPagado ? "PAGADO âœ…" : "IMPAGO âŒ";
                const checkAttr = esPagado ? "checked disabled" : "";
                const quienPago = item.acreedor; // A quiÃ©n le debo

                const html = `
                    <div class="shared-item ${claseEstado}" id="card-${item.id}">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge bg-light text-dark border">ğŸ“… ${item.fecha}</span>
                            <span class="badge ${esPagado ? 'bg-success' : 'bg-danger'} badge-status">${textoEstado}</span>
                        </div>
                        <h6 class="fw-bold mb-1">${item.desc}</h6>
                        <small class="text-muted d-block mb-2">Pagado por: <strong>${quienPago}</strong></small>
                        <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
                            <div class="fw-bold text-dark">A pagar: $${parteFmt}</div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" style="width:3em; height:1.5em;" 
                                       onchange="marcarPagado('${item.id}', this)" ${checkAttr}>
                            </div>
                        </div>
                    </div>
                `;
                lista.insertAdjacentHTML('beforeend', html);
            });
        }
        new bootstrap.Modal(document.getElementById('compartidosModal')).show();
    }

    function marcarPagado(id, checkbox) {
        if (!confirm("Â¿Confirmar pago?")) { checkbox.checked = false; return; }
        
        checkbox.disabled = true; // Bloquear para no doble click
        document.getElementById(`card-${id}`).style.opacity = "0.5";

        const payload = { accion: "actualizar_estado", id: id };
        
        // Enviamos peticiÃ³n con no-cors (no podemos leer respuesta pero confiamos)
        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            // ActualizaciÃ³n visual optimista
            const card = document.getElementById(`card-${id}`);
            card.classList.remove('impago'); 
            card.classList.add('pagado');
            card.querySelector('.badge-status').className = "badge bg-success badge-status";
            card.querySelector('.badge-status').innerText = "PAGADO âœ…";
            card.style.opacity = "0.7";
            
            // Restar del contador del botÃ³n
            const badge = document.getElementById('badge-deudas');
            let count = parseInt(badge.innerText) || 0;
            if(count > 0) badge.innerText = count - 1;
            if(count - 1 <= 0) badge.style.display = 'none';

            alert("âœ… Pago registrado correctamente.");
        }).catch(e => {
            alert("Hubo un error de conexiÃ³n, intenta de nuevo.");
            checkbox.disabled = false;
            checkbox.checked = false;
            document.getElementById(`card-${id}`).style.opacity = "1";
        });
    }
</script>

</body>
</html>
