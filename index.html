<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas J&G</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: system-ui, -apple-system, sans-serif; }
        .card { border-radius: 16px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .form-control, .form-select { border-radius: 12px; padding: 12px; font-size: 1rem; }
        .btn-lg { border-radius: 12px; font-weight: 600; padding: 14px; }
        
        /* Pantalla de Login */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        
        /* Avatares de Login */
        .avatar-btn {
            width: 120px; height: 120px; border-radius: 50%; border: 4px solid white;
            background-color: white; font-size: 3rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .avatar-btn:active { transform: scale(0.95); }
        
        .stat-card { transition: transform 0.2s; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="text-center text-white">
        <h1 class="fw-bold mb-4">ğŸ’° Finanzas J&G</h1>
        <p class="mb-5 opacity-75">Â¿QuiÃ©n estÃ¡ registrando?</p>
        
        <div class="d-flex gap-4 justify-content-center">
            <div class="text-center">
                <div class="avatar-btn text-primary mb-2" onclick="iniciarSesion('Jose')">ğŸ‘¨ğŸ»â€ğŸ’»</div>
                <div class="fw-bold">Jose</div>
            </div>
            
            <div class="text-center">
                <div class="avatar-btn text-danger mb-2" onclick="iniciarSesion('Gabriela')">ğŸ‘©ğŸ»â€ğŸ¨</div>
                <div class="fw-bold">Gabriela</div>
            </div>
        </div>
    </div>
</div>

<div id="app-screen" class="container py-3" style="max-width: 600px; display:none;">
    
    <div class="d-flex justify-content-between align-items-center mb-3 px-2">
        <div>
            <h3 class="fw-bold m-0" id="saludo-usuario">Hola!</h3>
            <small class="text-muted">Control de Gastos Mensual</small>
        </div>
        <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="cerrarSesion()">Salir</button>
    </div>

    <ul class="nav nav-pills nav-fill mb-3 bg-white p-1 rounded-3 shadow-sm" id="myTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active fw-bold" id="registro-tab" data-bs-toggle="tab" data-bs-target="#registro-pane" type="button">ğŸ“ Registrar</button>
        </li>
        <li class="nav-item">
            <button class="nav-link fw-bold" id="graficos-tab" data-bs-toggle="tab" data-bs-target="#graficos-pane" type="button" onclick="cargarDatos()">ğŸ“Š Mis Gastos</button>
        </li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="registro-pane">
            <div class="card">
                <div class="card-body p-4">
                    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
                    
                    <form id="financeForm" 
                          action="https://script.google.com/macros/s/AKfycbz2hTiT_DCceJkzh0_rMjy0EJkbDAgXEyztYAVNNMIAkb4CwQC1ySajrmmB8U7KO8ubuQ/exec" 
                          method="POST" target="hidden_iframe">
                        
                        <input type="hidden" name="usuario" id="usuario-input">

                        <div class="row g-2 mb-3">
                            <div class="col-5">
                                <label class="fw-bold small text-muted">TIPO</label>
                                <select class="form-select" name="tipo" id="tipoSelector" onchange="cambiarColor()">
                                    <option value="Gasto">Gasto ğŸ“‰</option>
                                    <option value="Ingreso">Ingreso ğŸ“ˆ</option>
                                </select>
                            </div>
                            <div class="col-7">
                                <label class="fw-bold small text-muted">MONTO</label>
                                <div class="input-group">
                                    <span class="input-group-text border-0 bg-light">$</span>
                                    <input type="text" class="form-control" name="monto" id="monto" placeholder="0" required inputmode="numeric">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="fw-bold small text-muted">CATEGORÃA</label>
                            <select class="form-select" name="categoria">
                                <option value="Supermercado">ğŸ›’ Supermercado</option>
                                <option value="Comida Fuera">ğŸ” Comida / Delivery</option>
                                <option value="Transporte">ğŸšŒ Transporte / Bencina</option>
                                <option value="Cuentas">ğŸ’¡ Cuentas / Servicios</option>
                                <option value="Arriendo">ğŸ  Arriendo / GC</option>
                                <option value="Mascotas">ğŸ¶ Mascotas</option>
                                <option value="Salud">ğŸ’Š Salud / Farmacia</option>
                                <option value="Ocio">ğŸ® Ocio / Streaming</option>
                                <option value="Otros">ğŸ“¦ Otros</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <input type="text" class="form-control" name="descripcion" placeholder="DescripciÃ³n (Opcional)">
                        </div>

                        <div class="alert alert-light border d-flex justify-content-between align-items-center">
                            <div>
                                <strong class="d-block small">Â¿Compartido? (50/50)</strong>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="es_compartido">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-danger w-100 btn-lg shadow-sm" id="btnSubmit">Registrar</button>
                    </form>
                </div>
            </div>
            
            <div class="mt-3 text-center">
                <small class="text-muted">Ãšltimos registros de esta sesiÃ³n:</small>
                <div id="historial" class="mt-2"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="graficos-pane">
            
            <div id="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Consultando tu deuda...</p>
            </div>

            <div id="stats-content" style="display:none;">
                
                <div class="card mb-3 stat-card bg-white border border-primary border-opacity-25">
                    <div class="card-body text-center pt-4">
                        <small class="text-uppercase text-muted fw-bold">Total Gastado este Mes</small>
                        <h1 class="display-4 fw-bold text-primary my-2" id="mi-total">$0</h1>
                        <p class="small text-muted mb-0">(Incluye tus gastos + la mitad de lo compartido)</p>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">DistribuciÃ³n de Gastos</h6>
                        <div style="height:250px; position:relative;">
                            <canvas id="miChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-light border" onclick="cargarDatos()">ğŸ”„ Actualizar mis datos</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- 1. CONFIGURACIÃ“N ---
    // !!! IMPORTANTE: PON TU URL DEL SCRIPT AQUÃ !!!
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2hTiT_DCceJkzh0_rMjy0EJkbDAgXEyztYAVNNMIAkb4CwQC1ySajrmmB8U7KO8ubuQ/exec";
    
    let usuarioActual = "";
    let myChart = null;

    // --- 2. SISTEMA DE LOGIN ---
    function iniciarSesion(nombre) {
        usuarioActual = nombre;
        
        // Ocultar login, mostrar app
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'block';
        
        // Personalizar interfaz
        document.getElementById('saludo-usuario').innerText = "Hola, " + nombre + "!";
        document.getElementById('usuario-input').value = nombre; // Llenar input oculto
    }

    function cerrarSesion() {
        location.reload(); // Recargar pÃ¡gina para volver al login
    }

    // --- 3. LÃ“GICA DE REGISTRO ---
    const montoInput = document.getElementById('monto');
    const form = document.getElementById('financeForm');
    const btnSubmit = document.getElementById('btnSubmit');
    var submitted = false;

    // Formato CLP (Puntos de miles)
    montoInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, "");
        e.target.value = value ? new Intl.NumberFormat('es-CL').format(value) : "";
    });

    function cambiarColor() {
        const tipo = document.getElementById('tipoSelector').value;
        if(tipo === 'Gasto') {
            btnSubmit.className = 'btn btn-danger w-100 btn-lg shadow-sm';
            btnSubmit.innerText = 'Registrar Gasto';
        } else {
            btnSubmit.className = 'btn btn-success w-100 btn-lg shadow-sm';
            btnSubmit.innerText = 'Registrar Ingreso';
        }
    }

    form.onsubmit = function() {
        submitted = true;
        btnSubmit.innerText = "Guardando...";
        btnSubmit.disabled = true;
    };

    document.getElementById('hidden_iframe').onload = function() {
        if (submitted) {
            // Historial visual rÃ¡pido
            agregarHistorialVisual(form.categoria.value, form.monto.value, form.tipo.value);
            
            alert("âœ… Â¡Registrado correctamente!");
            form.reset();
            
            // Restaurar usuario y botÃ³n
            document.getElementById('usuario-input').value = usuarioActual;
            btnSubmit.innerText = "Registrar Gasto";
            btnSubmit.disabled = false;
            submitted = false;
            cambiarColor();
        }
    };

    function agregarHistorialVisual(cat, monto, tipo) {
        const color = tipo === 'Gasto' ? 'text-danger' : 'text-success';
        const html = `<div class="badge bg-light text-dark border me-1 mb-1">${cat}: <span class="${color}">$${monto}</span></div>`;
        document.getElementById('historial').insertAdjacentHTML('afterbegin', html);
    }


    // --- 4. LÃ“GICA DE GRÃFICOS (FILTRADO POR USUARIO) ---
    function cargarDatos() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('stats-content').style.display = 'none';

        fetch(APPS_SCRIPT_URL)
            .then(response => response.json())
            .then(data => {
                // Filtramos SOLO los datos del usuario logueado
                const datosUsuario = data[usuarioActual];
                mostrarGraficoPersonal(datosUsuario);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('stats-content').style.display = 'block';
            })
            .catch(error => {
                console.error("Error:", error);
                document.getElementById('loading').innerHTML = "<p class='text-danger'>Error de conexiÃ³n</p>";
            });
    }

    function mostrarGraficoPersonal(datos) {
        // Actualizar Total Grande
        document.getElementById('mi-total').innerText = "$ " + new Intl.NumberFormat('es-CL').format(datos.total);

        // Preparar GrÃ¡fico
        const ctx = document.getElementById('miChart').getContext('2d');
        if (myChart) myChart.destroy();

        // Colores
        const colors = ['#ff7675', '#74b9ff', '#ffeaa7', '#55efc4', '#a29bfe', '#fab1a0', '#00b894', '#636e72'];

        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(datos.desglose),
                datasets: [{
                    data: Object.values(datos.desglose),
                    backgroundColor: colors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
</script>

</body>
</html>
