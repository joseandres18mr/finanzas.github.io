<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas J&G</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: system-ui, -apple-system, sans-serif; }
        .card { border-radius: 16px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .form-control, .form-select { border-radius: 12px; padding: 12px; }
        .btn-lg { border-radius: 12px; font-weight: 600; }
        .nav-pills .nav-link.active { background-color: #333; color: white; border-radius: 10px; }
        .nav-pills .nav-link { color: #666; }
        
        /* Colores */
        .bg-jose { background-color: #3498db; color: white; }
        .bg-gaby { background-color: #e84393; color: white; }
        
        .stat-card { transition: transform 0.2s; }
        .stat-card:active { transform: scale(0.98); }
    </style>
</head>
<body>

<div class="container py-3" style="max-width: 600px;">
    
    <div class="text-center mb-3">
        <h3 class="fw-bold m-0">üí∞ Finanzas J&G</h3>
        <p class="text-muted small">Control Mensual</p>
    </div>

    <ul class="nav nav-pills nav-fill mb-3 bg-white p-1 rounded-3 shadow-sm" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold" id="registro-tab" data-bs-toggle="tab" data-bs-target="#registro-pane" type="button">üìù Registrar</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="graficos-tab" data-bs-toggle="tab" data-bs-target="#graficos-pane" type="button" onclick="cargarDatos()">üìä Gr√°ficos</button>
        </li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="registro-pane">
            <div class="card">
                <div class="card-body p-4">
                    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
                    
                    <form id="financeForm" 
                          action="https://script.google.com/macros/s/AKfycbz2hTiT_DCceJkzh0_rMjy0EJkbDAgXEyztYAVNNMIAkb4CwQC1ySajrmmB8U7KO8ubuQ/exec" 
                          method="POST" target="hidden_iframe">
                        
                        <div class="mb-3">
                            <label class="fw-bold">¬øQui√©n registra?</label>
                            <select class="form-select" name="usuario">
                                <option value="Jose">Jose</option>
                                <option value="Gabriela">Gabriela</option>
                            </select>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-5">
                                <label class="fw-bold">Tipo</label>
                                <select class="form-select" name="tipo" id="tipoSelector" onchange="cambiarColor()">
                                    <option value="Gasto">Gasto üìâ</option>
                                    <option value="Ingreso">Ingreso üìà</option>
                                </select>
                            </div>
                            <div class="col-7">
                                <label class="fw-bold">Monto</label>
                                <div class="input-group">
                                    <span class="input-group-text border-0 bg-light">$</span>
                                    <input type="text" class="form-control" name="monto" id="monto" placeholder="0" required inputmode="numeric">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="fw-bold">Categor√≠a</label>
                            <select class="form-select" name="categoria">
                                <option value="Supermercado">üõí Supermercado</option>
                                <option value="Comida Fuera">üçî Comida / Delivery</option>
                                <option value="Transporte">üöå Transporte / Bencina</option>
                                <option value="Cuentas">üí° Cuentas / Servicios</option>
                                <option value="Arriendo">üè† Arriendo / GC</option>
                                <option value="Mascotas">üê∂ Mascotas</option>
                                <option value="Salud">üíä Salud / Farmacia</option>
                                <option value="Ocio">üéÆ Ocio / Streaming</option>
                                <option value="Otros">üì¶ Otros</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <input type="text" class="form-control" name="descripcion" placeholder="Descripci√≥n (Opcional)">
                        </div>

                        <div class="alert alert-light border d-flex justify-content-between align-items-center">
                            <div>
                                <strong class="d-block">¬øEs compartido?</strong>
                                <span class="text-muted small">Se divide 50/50 en los gr√°ficos</span>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="es_compartido">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-danger w-100 btn-lg shadow-sm" id="btnSubmit">Registrar Gasto</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="graficos-pane">
            
            <div id="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Calculando gastos del mes...</p>
            </div>

            <div id="stats-content" style="display:none;">
                
                <div class="card mb-3 stat-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold m-0 text-primary">Jose</h5>
                            <span class="badge bg-primary rounded-pill" id="total-jose">$0</span>
                        </div>
                        <div style="height:200px; position:relative;">
                            <canvas id="chartJose"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card mb-3 stat-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold m-0 text-danger">Gabriela</h5>
                            <span class="badge bg-danger rounded-pill" id="total-gaby">$0</span>
                        </div>
                        <div style="height:200px; position:relative;">
                            <canvas id="chartGaby"></canvas>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info small text-center">
                    <i class="bi bi-info-circle"></i> Los gastos compartidos ya est√°n divididos a la mitad en cada gr√°fico.
                </div>
                
                <button class="btn btn-outline-secondary w-100 btn-sm" onclick="cargarDatos()">üîÑ Actualizar datos</button>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // URL DEL SCRIPT (Debe ser la misma del form)
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2hTiT_DCceJkzh0_rMjy0EJkbDAgXEyztYAVNNMIAkb4CwQC1ySajrmmB8U7KO8ubuQ/exec";

    // --- 1. L√ìGICA DE REGISTRO (Tuya original mejorada) ---
    const montoInput = document.getElementById('monto');
    const form = document.getElementById('financeForm');
    const btnSubmit = document.getElementById('btnSubmit');
    var submitted = false;

    // Formato miles
    montoInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, "");
        e.target.value = value ? new Intl.NumberFormat('es-CL').format(value) : "";
    });

    function cambiarColor() {
        const tipo = document.getElementById('tipoSelector').value;
        if(tipo === 'Gasto') {
            btnSubmit.className = 'btn btn-danger w-100 btn-lg shadow-sm';
            btnSubmit.innerText = 'Registrar Gasto';
        } else {
            btnSubmit.className = 'btn btn-success w-100 btn-lg shadow-sm';
            btnSubmit.innerText = 'Registrar Ingreso';
        }
    }

    form.onsubmit = function() {
        submitted = true;
        btnSubmit.innerText = "Guardando...";
        btnSubmit.disabled = true;
    };

    document.getElementById('hidden_iframe').onload = function() {
        if (submitted) {
            alert("‚úÖ ¬°Guardado!");
            form.reset();
            btnSubmit.innerText = "Registrar Gasto";
            btnSubmit.disabled = false;
            submitted = false;
            cambiarColor();
        }
    };


    // --- 2. L√ìGICA DE GR√ÅFICOS (Nueva) ---
    let myChartJose = null;
    let myChartGaby = null;

    function cargarDatos() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('stats-content').style.display = 'none';

        fetch(APPS_SCRIPT_URL)
            .then(response => response.json())
            .then(data => {
                mostrarGraficos(data);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('stats-content').style.display = 'block';
            })
            .catch(error => {
                console.error("Error cargando gr√°ficos:", error);
                alert("Error cargando datos. Revisa la consola.");
                document.getElementById('loading').style.display = 'none';
            });
    }

    function mostrarGraficos(data) {
        // Formateador de dinero
        const fmt = (num) => "$ " + new Intl.NumberFormat('es-CL').format(num);

        // Actualizar totales texto
        document.getElementById('total-jose').innerText = fmt(data.Jose.total);
        document.getElementById('total-gaby').innerText = fmt(data.Gabriela.total);

        // Renderizar Chart Jose
        renderChart('chartJose', data.Jose.desglose, 'Jose', myChartJose, (c) => myChartJose = c);
        
        // Renderizar Chart Gabriela
        renderChart('chartGaby', data.Gabriela.desglose, 'Gabriela', myChartGaby, (c) => myChartGaby = c);
    }

    function renderChart(canvasId, desglose, persona, chartInstance, setChart) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        // Destruir gr√°fico anterior si existe
        if (chartInstance) chartInstance.destroy();

        const labels = Object.keys(desglose);
        const values = Object.values(desglose);
        
        // Colores bonitos
        const colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#2ecc71', '#e74c3c'
        ];

        const newChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } }
                }
            }
        });
        setChart(newChart);
    }
</script>

</body>
</html>
