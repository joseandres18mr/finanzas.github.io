<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas J&G</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: system-ui, -apple-system, sans-serif; }
        .card { border-radius: 16px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .form-control, .form-select { border-radius: 12px; padding: 12px; font-size: 1rem; }
        .btn-lg { border-radius: 12px; font-weight: 600; padding: 14px; }
        
        /* Pantalla de Login */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .avatar-btn {
            width: 120px; height: 120px; border-radius: 50%; border: 4px solid white;
            background-color: white; font-size: 3rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .avatar-btn:active { transform: scale(0.95); }
        
        /* Modal Detalle */
        .modal-content { border-radius: 20px; border: none; }
        .item-detalle { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .item-detalle:last-child { border-bottom: none; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="text-center text-white">
        <h1 class="fw-bold mb-4">üí∞ Finanzas J&G</h1>
        <p class="mb-5 opacity-75">¬øQui√©n est√° registrando?</p>
        <div class="d-flex gap-4 justify-content-center">
            <div class="text-center">
                <div class="avatar-btn text-primary mb-2" onclick="iniciarSesion('Jose')">üë®üèª‚Äçüíª</div>
                <div class="fw-bold">Jose</div>
            </div>
            <div class="text-center">
                <div class="avatar-btn text-danger mb-2" onclick="iniciarSesion('Gabriela')">üë©üèª‚Äçüé®</div>
                <div class="fw-bold">Gabriela</div>
            </div>
        </div>
    </div>
</div>

<div id="app-screen" class="container py-3" style="max-width: 600px; display:none;">
    
    <div class="d-flex justify-content-between align-items-center mb-3 px-2">
        <div>
            <h3 class="fw-bold m-0" id="saludo-usuario">Hola!</h3>
            <small class="text-muted">Control de Gastos Mensual</small>
        </div>
        <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="cerrarSesion()">Salir</button>
    </div>

    <ul class="nav nav-pills nav-fill mb-3 bg-white p-1 rounded-3 shadow-sm">
        <li class="nav-item">
            <button class="nav-link active fw-bold" id="registro-tab" data-bs-toggle="tab" data-bs-target="#registro-pane">üìù Registrar</button>
        </li>
        <li class="nav-item">
            <button class="nav-link fw-bold" id="graficos-tab" data-bs-toggle="tab" data-bs-target="#graficos-pane" onclick="cargarDatos()">üìä Mis Gastos</button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="registro-pane">
            <div class="card">
                <div class="card-body p-4">
                    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
                    
                    <form id="financeForm" 
                          action="https://script.google.com/macros/s/AKfycbz2hTiT_DCceJkzh0_rMjy0EJkbDAgXEyztYAVNNMIAkb4CwQC1ySajrmmB8U7KO8ubuQ/exec" 
                          method="POST" target="hidden_iframe">
                        
                        <input type="hidden" name="usuario" id="usuario-input">

                        <div class="row g-2 mb-3">
                            <div class="col-5">
                                <label class="fw-bold small text-muted">TIPO</label>
                                <select class="form-select" name="tipo" id="tipoSelector" onchange="cambiarColor()">
                                    <option value="Gasto">Gasto üìâ</option>
                                    <option value="Ingreso">Ingreso üìà</option>
                                </select>
                            </div>
                            <div class="col-7">
                                <label class="fw-bold small text-muted">MONTO</label>
                                <div class="input-group">
                                    <span class="input-group-text border-0 bg-light">$</span>
                                    <input type="text" class="form-control" name="monto" id="monto" placeholder="0" required inputmode="numeric">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="fw-bold small text-muted">CATEGOR√çA</label>
                            <select class="form-select" name="categoria">
                                <option value="Supermercado">üõí Supermercado</option>
                                <option value="Comida Fuera">üçî Comida / Delivery</option>
                                <option value="Transporte">üöå Transporte / Bencina</option>
                                <option value="Cuentas">üí° Cuentas / Servicios</option>
                                <option value="Arriendo">üè† Arriendo / GC</option>
                                <option value="Mascotas">üê∂ Mascotas</option>
                                <option value="Salud">üíä Salud / Farmacia</option>
                                <option value="Ocio">üéÆ Ocio / Streaming</option>
                                <option value="Otros">üì¶ Otros</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <input type="text" class="form-control" name="descripcion" placeholder="Descripci√≥n (Opcional)">
                        </div>

                        <div class="alert alert-light border d-flex justify-content-between align-items-center">
                            <div><strong class="d-block small">¬øCompartido? (50/50)</strong></div>
                            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="es_compartido"></div>
                        </div>

                        <button type="submit" class="btn btn-danger w-100 btn-lg shadow-sm" id="btnSubmit">Registrar</button>
                    </form>
                </div>
            </div>
            
            <div class="mt-3 text-center">
                <small class="text-muted">√öltimos registros de esta sesi√≥n:</small>
                <div id="historial" class="mt-2"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="graficos-pane">
            <div id="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Consultando detalle...</p>
            </div>

            <div id="stats-content" style="display:none;">
                <div class="card mb-3 stat-card bg-white border border-primary border-opacity-25">
                    <div class="card-body text-center pt-4">
                        <small class="text-uppercase text-muted fw-bold">Total Gastado este Mes</small>
                        <h1 class="display-4 fw-bold text-primary my-2" id="mi-total">$0</h1>
                        <p class="small text-muted mb-0">(Toca el gr√°fico para ver detalle)</p>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">Distribuci√≥n (Click para detalle)</h6>
                        <div style="height:300px; position:relative;">
                            <canvas id="miChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-light border" onclick="cargarDatos()">üîÑ Actualizar datos</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detalleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="modalTitulo">Detalle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-2">
                <div id="lista-detalle">
                    </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary w-100 rounded-pill" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- 1. CONFIGURACI√ìN ---
    // !!! PEGA TU URL DE SCRIPT AQUI !!!
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2hTiT_DCceJkzh0_rMjy0EJkbDAgXEyztYAVNNMIAkb4CwQC1ySajrmmB8U7KO8ubuQ/exec";
    
    let usuarioActual = "";
    let myChart = null;
    let datosActuales = null; // Para guardar los datos descargados

    // --- 2. LOGIN Y UI ---
    function iniciarSesion(nombre) {
        usuarioActual = nombre;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'block';
        document.getElementById('saludo-usuario').innerText = "Hola, " + nombre + "!";
        document.getElementById('usuario-input').value = nombre;
    }

    function cerrarSesion() { location.reload(); }

    // --- 3. REGISTRO ---
    const montoInput = document.getElementById('monto');
    const form = document.getElementById('financeForm');
    const btnSubmit = document.getElementById('btnSubmit');
    var submitted = false;

    montoInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, "");
        e.target.value = value ? new Intl.NumberFormat('es-CL').format(value) : "";
    });

    function cambiarColor() {
        const tipo = document.getElementById('tipoSelector').value;
        if(tipo === 'Gasto') {
            btnSubmit.className = 'btn btn-danger w-100 btn-lg shadow-sm';
            btnSubmit.innerText = 'Registrar Gasto';
        } else {
            btnSubmit.className = 'btn btn-success w-100 btn-lg shadow-sm';
            btnSubmit.innerText = 'Registrar Ingreso';
        }
    }

    form.onsubmit = function() {
        submitted = true;
        btnSubmit.innerText = "Guardando...";
        btnSubmit.disabled = true;
    };

    document.getElementById('hidden_iframe').onload = function() {
        if (submitted) {
            agregarHistorialVisual(form.categoria.value, form.monto.value, form.tipo.value);
            alert("‚úÖ ¬°Registrado!");
            form.reset();
            document.getElementById('usuario-input').value = usuarioActual;
            btnSubmit.innerText = "Registrar Gasto";
            btnSubmit.disabled = false;
            submitted = false;
            cambiarColor();
        }
    };

    function agregarHistorialVisual(cat, monto, tipo) {
        const color = tipo === 'Gasto' ? 'text-danger' : 'text-success';
        const html = `<div class="badge bg-light text-dark border me-1 mb-1">${cat}: <span class="${color}">$${monto}</span></div>`;
        document.getElementById('historial').insertAdjacentHTML('afterbegin', html);
    }

    // --- 4. GR√ÅFICOS INTERACTIVOS ---
    function cargarDatos() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('stats-content').style.display = 'none';

        fetch(APPS_SCRIPT_URL)
            .then(response => response.json())
            .then(data => {
                datosActuales = data[usuarioActual].desglose; // Guardamos el detalle
                const total = data[usuarioActual].total;
                
                document.getElementById('mi-total').innerText = "$ " + new Intl.NumberFormat('es-CL').format(total);
                mostrarGrafico(datosActuales);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('stats-content').style.display = 'block';
            })
            .catch(error => { console.error(error); document.getElementById('loading').innerHTML = "Error conexi√≥n"; });
    }

    function mostrarGrafico(desglose) {
        const ctx = document.getElementById('miChart').getContext('2d');
        if (myChart) myChart.destroy();

        // Extraer etiquetas y valores TOTALES
        const labels = Object.keys(desglose);
        const dataValues = labels.map(key => desglose[key].valor);

        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: dataValues,
                    backgroundColor: ['#ff7675', '#74b9ff', '#ffeaa7', '#55efc4', '#a29bfe', '#fab1a0', '#00b894'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                onClick: (evt, elements) => {
                    if(elements.length > 0) {
                        const index = elements[0].index;
                        const categoriaClick = labels[index];
                        abrirModalDetalle(categoriaClick);
                    }
                },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    // --- 5. MODAL DE DETALLE ---
    function abrirModalDetalle(categoria) {
        const items = datosActuales[categoria].items;
        const modalTitle = document.getElementById('modalTitulo');
        const lista = document.getElementById('lista-detalle');
        
        modalTitle.innerText = "Detalle: " + categoria;
        lista.innerHTML = ""; // Limpiar anterior

        if (items.length === 0) {
            lista.innerHTML = "<p class='text-center text-muted'>Sin detalles disponibles</p>";
        } else {
            items.forEach(item => {
                const montoFmt = new Intl.NumberFormat('es-CL').format(item.monto);
                const desc = item.desc || "Sin descripci√≥n";
                
                const fila = `
                    <div class="item-detalle">
                        <div>
                            <div class="fw-bold">${desc}</div>
                        </div>
                        <div class="text-danger fw-bold">$ ${montoFmt}</div>
                    </div>
                `;
                lista.insertAdjacentHTML('beforeend', fila);
            });
        }

        // Abrir Modal Bootstrap
        var myModal = new bootstrap.Modal(document.getElementById('detalleModal'));
        myModal.show();
    }
</script>

</body>
</html>
